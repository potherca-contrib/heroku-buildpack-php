#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

################################################################################
# Potherca Custom Heroku Compile script for PHP apps with Composer Dependencies
# ------------------------------------------------------------------------------
# Sometimes the standards are just not what you need, so I am hacking my own.
#
# The default (and most custom) PHP buildpacks place the entire application in
# the web root directory of the application.
#
# I don't like that, since I tend to have my applications setup more neatly, so
# this buildpack will keep the entire application in the project root and only
# move public content to the web root.
#
# Some notes on Heroku Buildpacks:
#
# BUILD_DIR will be the location of the app and CACHE_DIR will be a location the
# buildpack can use to cache build artifacts between builds. As the contents of
# CACHE_DIR will be persisted between builds, you can cache the results of long
# processes like dependency resolution here to speed up future builds.
#
# The application in BUILD_DIR along with all changes made by the compile script
# will be packaged into a slug
#
# All output received on STDOUT from this script will be displayed to the user.
#
# For full details see https://devcenter.heroku.com/articles/buildpack-api
################################################################################


# ==============================================================================
# CONFIG
# ------------------------------------------------------------------------------
# fail fast
set -e
#set -x
# ==============================================================================


# ==============================================================================
# The files in the project root we don't want moved to the root
# ------------------------------------------------------------------------------
# @FIXME: Any files that need to remain in /app/www that are not in /app/www/web need to be read from a file in the project
declare -a aKeep
#aKeep+=('.buildpacks')
#aKeep+=('.profile.d')
#aKeep+=('vendor')
#aKeep+=('last_pack_release.out')
# ==============================================================================

sTarbalUrl='https://heroku-buildpack-php.s3.amazonaws.com'

# Heroku Revision.
#
# Affixed to all vendored binary output to represent changes to the
# compilation environment without a change to the upstream version,
# e.g. PHP 5.3.27 without, and then subsequently with, libmcrypt.
heroku_rev='2'

APACHE_VERSION="2.2.25"
MCRYPT_VERSION="2.5.8"
PHP_VERSION="5.3.27"

# ==============================================================================
# ------------------------------------------------------------------------------
APACHE_PATH="apache"
APACHE_URL="${sTarbalUrl}/apache-${APACHE_VERSION}-${heroku_rev}.tar.gz"
# ==============================================================================


# ==============================================================================
# ------------------------------------------------------------------------------
MCRYPT_URL="${sTarbalUrl}/mcrypt-${MCRYPT_VERSION}-${heroku_rev}.tar.gz"
# ==============================================================================

# ==============================================================================
# ------------------------------------------------------------------------------
PHP_PATH="php" # @CHECKME: Unused variable. Why?
PHP_URL="${sTarbalUrl}/php-${PHP_VERSION}-${heroku_rev}.tar.gz"
# ==============================================================================


# ==============================================================================
# ------------------------------------------------------------------------------
BIN_DIR=$(dirname $0)
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`
# ==============================================================================

################################################################################
# FUNCTIONS
################################################################################
# ==============================================================================
# Check if a value exists in an array
# ------------------------------------------------------------------------------
# @param $1 mixed  Needle  
# @param $2 array  Haystack
# @return  Success (0) if value exists, Failure (1) otherwise
# Usage: in_array "$needle" "${haystack[@]}"
# See: http://fvue.nl/wiki/Bash:_Check_if_array_element_exists
# ------------------------------------------------------------------------------
in_array(){
    local hay needle=$1
    shift
    for hay; do
        [[ $hay == $needle ]] && return 0
    done
    return 1
}
# ==============================================================================

# ==============================================================================
# Output some system information
# ------------------------------------------------------------------------------
function echoInfo(){
    echo '# =============================================================================='
    echo "BIN_DIR   = ${BIN_DIR}"
    echo "BUILD_DIR = ${BUILD_DIR}"
    echo "CACHE_DIR = ${CACHE_DIR}"
    echo "LP_DIR    = ${LP_DIR}"
    echo "HOME      = ${HOME}"
    echo "pwd       = `pwd`"
    echo '# ------------------------------------------------------------------------------'
}
# ==============================================================================


# ==============================================================================
# Prepare for action
# ------------------------------------------------------------------------------
function preRun(){
    #echoInfo
	echo '=====> Preparing...'
    # include .files when moving things around
    shopt -s dotglob

    # go to the start
    cd $BUILD_DIR
}
# ==============================================================================


function keep() {
    echo "----->     Attempt to move ${1}"
    if [ -f "www/${1}" ]; then
      mv -v --target-directory="${HOME}/" "www/${1}"
    elif [ -d "www/${1}" ]; then
      mv -v --target-directory="${HOME}/" "www/${1}"
    else
        echo "----->          !     FAILED TO MOVE ${1} to ${HOME}"
    fi
}
# ==============================================================================
# move app things to www
# ------------------------------------------------------------------------------
function moveAppToWebRoot(){
    echo "-----> Moving Project Files"
    mkdir -p $CACHE_DIR/www

    #if [ -d "www/" ]; then
    #    echo "     -----> Moving `pwd`/www/* to `pwd`"
    #    #mv -v --target-directory="." "www/*"
    #    mv -v "./www/*" "./*"
    #else
    #    echo "     ERROR> Could not find a 'www' directory in `pwd`"
    #fi

    for sItem in $( ls ); do
        in_array "${sItem}" "${aKeep[@]}" || mv "${sItem}" "${CACHE_DIR}/www"
    done

    mv $CACHE_DIR/www .

    # keep Procfile
    if [ -f www/Procfile ]; then
      mv -v www/Procfile .
    fi
}
# ==============================================================================


# ==============================================================================
# Install Apache
# ------------------------------------------------------------------------------
function installApache(){
    install 'Apache' "${APACHE_VERSION}" "${APACHE_URL}"
}
# ==============================================================================


# ==============================================================================
# Install PHP
# ------------------------------------------------------------------------------
function installPhp(){
    install 'PHP' "${PHP_VERSION}" "${PHP_URL}"
}
# ==============================================================================


# ==============================================================================
# Install PHP
# ------------------------------------------------------------------------------
function installMcrypt(){
    install 'mcrypt' "${MCRYPT_VERSION}" "$MCRYPT_URL"
}
# ==============================================================================

# ==============================================================================
# Install PHP
# ------------------------------------------------------------------------------
function install(){
    echo "-----> Bundling ${1} version ${2}"
    curl --silent --max-time 60 --location "${3}" | tar xz
}
# ==============================================================================


# ==============================================================================
# update config files
# ------------------------------------------------------------------------------
function updateConfig(){
    echo "-----> Updating config files"
    cp $LP_DIR/conf/httpd.conf $APACHE_PATH/conf
    cp $LP_DIR/conf/php.ini php
}
# ==============================================================================


# ==============================================================================
# make php available on bin
# ------------------------------------------------------------------------------
function linkBinaries(){
    echo "-----> Linking binaries"
    mkdir -p bin
    ln -s /app/php/bin/php bin/php
}
# ==============================================================================


# ==============================================================================
# check if we have Composer dependencies and vendors are not bundled
# ------------------------------------------------------------------------------
function runComposer(){
    echo "-----> Checking for Composer dependencies"
    if [ -f www/composer.json ] && [ ! -d www/vendor ]; then
      echo "       -----> Composer dependencies found"
      COMPOSER_URL="http://getcomposer.org/composer.phar"
      GIT_DIR_ORIG=$GIT_DIR
      unset GIT_DIR

      echo "       -----> Fetching Composer"
      curl --silent --max-time 60 --location "$COMPOSER_URL" > www/composer.phar
      cd www

      echo "       -----> Running Composer"
      #LD_LIBRARY_PATH=$BUILD_DIR/php
      $BUILD_DIR/php/bin/php -c $LP_DIR/conf/php.ini composer.phar install --prefer-source

      echo "       -----> Cleaning up after Composer"
      rm -rf vendor/**/.git
      cd $BUILD_DIR
      rm www/composer.phar
      export GIT_DIR=$GIT_DIR_ORIG
    fi
}
# ==============================================================================


# ==============================================================================
# Setup boot file that runs our web worker
# ------------------------------------------------------------------------------
function createBootScript(){
    echo "-----> Creating boot script"
    # @FIXME: We should check the project files for post-install/boot commands and add those too!
    cat >> boot.sh <<EOF
    echo "=====> Running Boot Script"

    echo "-----> Checking for Composer dependencies"
    if [ -f /app/www/composer.json ] && [ ! -d /app/www/vendor ]; then
        echo "       -----> Composer dependencies found"
        COMPOSER_URL="http://getcomposer.org/composer.phar"
        #GIT_DIR_ORIG=$GIT_DIR
        #unset GIT_DIR

        echo "       -----> Fetching Composer"
        curl --silent --max-time 60 --location "$COMPOSER_URL" > /app/www/composer.phar
        cd /app/www

        echo "       -----> Running Composer"
        /app/bin/php composer.phar install --prefer-source

        echo "       -----> Cleaning up after Composer"
        #rm -rf vendor/**/.git
        rm /app/www/composer.phar
        #export GIT_DIR=$GIT_DIR_ORIG
    fi

    for var in \`env|cut -f1 -d=\`; do
      echo "PassEnv \$var" >> /app/apache/conf/httpd.conf;
    done
    touch /app/apache/logs/error_log
    touch /app/apache/logs/access_log
    tail -F /app/apache/logs/error_log &
    tail -F /app/apache/logs/access_log &
    export LD_LIBRARY_PATH=/app/php
    export PHP_INI_SCAN_DIR=/app/www
    echo "Launching Apache"
    exec /app/apache/bin/httpd -DNO_DETACH

EOF

    chmod +x boot.sh
}
# ==============================================================================


# ==============================================================================
# Clean up after ourselves
# ------------------------------------------------------------------------------
function postRun(){
	echo '=====> Cleaning Up'
    # clean the cache
    #rm -rf $CACHE_DIR/*
} 
# ==============================================================================


# ==============================================================================
# On your places... Set... Go!
# ------------------------------------------------------------------------------
function run (){
    echo "=====> Running Install"
    moveAppToWebRoot

    #installMcrypt
    #installApache
    #installPhp
#MCRYPT_URL="https://heroku-buildpack-php.s3.amazonaws.com/mcrypt-""$MCRYPT_VERSION""$heroku_rev"".tar.gz"
echo "-----> Bundling mcrypt version $MCRYPT_VERSION"
curl --silent --max-time 60 --location "$MCRYPT_URL" | tar xz

#APACHE_URL="https://heroku-buildpack-php.s3.amazonaws.com/apache-""$APACHE_VERSION""$heroku_rev"".tar.gz"
echo "-----> Bundling Apache version $APACHE_VERSION"
curl --silent --max-time 60 --location "$APACHE_URL" | tar xz

#PHP_URL="https://heroku-buildpack-php.s3.amazonaws.com/php-$PHP_VERSION""$heroku_rev"".tar.gz"
echo "-----> Bundling PHP version $PHP_VERSION"
curl --silent --max-time 60 --location "$PHP_URL" | tar xz


    updateConfig
    linkBinaries

    #runComposer

    createBootScript
}
# ==============================================================================

echo "=====> Running Script ${0}"

preRun
run
postRun

#EOF